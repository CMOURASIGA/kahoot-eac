<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <title>Quiz EAC - Gamificado</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

    :root {
      --primary-color: #0B2043;
      --secondary-color: #D72638;
      --accent-color: #f59e0b;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --text-light: #ffffff;
      --text-dark: #1f2937;
      --bg-gradient: linear-gradient(135deg, #0f325a 0%, #0B2043 100%);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-light);
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow-x: hidden;
    }

    /* Anima√ß√µes de entrada */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% {
        transform: translateY(0);
      }
      40%, 43% {
        transform: translateY(-10px);
      }
      70% {
        transform: translateY(-5px);
      }
      90% {
        transform: translateY(-2px);
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    @keyframes confetti {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* Header com logo e pontua√ß√£o */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-eac {
      max-width: 60px;
      height: auto;
      border-radius: 8px;
    }

    .score-display {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .score-icon {
      font-size: 20px;
    }

    /* Container principal */
    #tela {
      max-width: 700px;
      width: 100%;
      margin: 100px auto 20px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideInUp 0.6s ease-out;
      position: relative;
      overflow: hidden;
    }

    /* Barra de progresso */
    .progress-container {
      margin-bottom: 30px;
      position: relative;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success-color), var(--accent-color));
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      margin-top: 8px;
      font-size: 14px;
      opacity: 0.9;
    }

    /* Timer */
    .timer-container {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--warning-color);
      color: var(--text-dark);
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 16px;
      min-width: 60px;
      animation: pulse 1s infinite;
    }

    .timer-urgent {
      background: var(--error-color);
      color: var(--text-light);
      animation: pulse 0.5s infinite;
    }

    /* T√≠tulos */
    h1, h2, h3 {
      color: var(--text-light);
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #fff, #f0f9ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    h2 {
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1.3;
    }

    /* Bot√µes principais */
    button {
      background: var(--text-light);
      border: none;
      color: var(--text-dark);
      font-weight: 700;
      font-size: 16px;
      padding: 14px 24px;
      margin: 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s;
    }

    button:hover::before {
      left: 100%;
    }

    button:hover {
      background: var(--accent-color);
      color: var(--text-light);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    button:active {
      transform: translateY(0);
    }

    .quiz-button {
      display: inline-block;
      width: 90%;
      max-width: 350px;
      font-size: 18px;
      padding: 16px 24px;
    }

    /* Grid de op√ß√µes */
    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }

    .option-button {
      font-size: 18px;
      font-weight: 700;
      padding: 24px 20px;
      color: var(--text-light);
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    /* Cores das op√ß√µes estilo Kahoot */
    .option-red    { 
      background: linear-gradient(135deg, #e53e3e, #c53030);
    }
    .option-blue   { 
      background: linear-gradient(135deg, #3182ce, #2c5282);
    }
    .option-yellow { 
      background: linear-gradient(135deg, #d69e2e, #b7791f);
      color: var(--text-dark);
    }
    .option-green  { 
      background: linear-gradient(135deg, #38a169, #2f855a);
    }

    .option-button:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    .option-button:active {
      transform: translateY(-2px) scale(0.98);
    }

    /* √çcones das op√ß√µes */
    .option-icon {
      font-size: 24px;
      font-weight: bold;
    }

    .option-red .option-icon::before    { content: "‚ñ≤"; }
    .option-blue .option-icon::before   { content: "‚ô¶"; }
    .option-yellow .option-icon::before { content: "‚óè"; }
    .option-green .option-icon::before  { content: "‚ñ†"; }

    /* Estados de feedback */
    .option-correct {
      background: linear-gradient(135deg, var(--success-color), #059669) !important;
      animation: bounce 0.6s ease;
    }

    .option-incorrect {
      background: linear-gradient(135deg, var(--error-color), #dc2626) !important;
      animation: shake 0.6s ease;
    }

    .option-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Feedback visual */
    .feedback-container {
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 18px;
      animation: slideInUp 0.4s ease;
    }

    .feedback-correct {
      background: rgba(16, 185, 129, 0.2);
      border: 2px solid var(--success-color);
      color: var(--success-color);
    }

    .feedback-incorrect {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid var(--error-color);
      color: var(--error-color);
    }

    /* Confetti para acertos */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--accent-color);
      animation: confetti 3s linear infinite;
      z-index: 1000;
    }

    .confetti:nth-child(odd) {
      background: var(--success-color);
      animation-delay: 0.5s;
    }

    .confetti:nth-child(3n) {
      background: var(--primary-color);
      animation-delay: 1s;
    }

    /* Mensagens de erro */
    .error-message {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid var(--error-color);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      animation: slideInUp 0.4s ease;
    }

    /* Responsividade */
    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 10px 15px;
      }

      .logo-eac {
        max-width: 50px;
      }

      .score-display {
        font-size: 16px;
        padding: 6px 12px;
      }

      #tela {
        padding: 25px;
        margin: 80px auto 20px;
      }

      .timer-container {
        top: 15px;
        right: 15px;
        font-size: 14px;
        padding: 6px 10px;
      }

      h1 {
        font-size: 2rem;
      }

      h2 {
        font-size: 1.4rem;
      }

      .option-button {
        font-size: 16px;
        padding: 20px 15px;
        min-height: 70px;
      }

      .options {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .quiz-button {
        width: 100%;
        font-size: 16px;
      }
    }

    @media screen and (max-width: 480px) {
      #tela {
        padding: 20px;
      }

      .option-button {
        font-size: 14px;
        padding: 16px 12px;
        min-height: 60px;
      }

      h1 {
        font-size: 1.8rem;
      }

      h2 {
        font-size: 1.2rem;
      }
    }

    /* Efeitos especiais */
    .celebration {
      animation: bounce 0.6s ease;
    }

    .streak-indicator {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--accent-color);
      color: var(--text-dark);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      animation: pulse 1s infinite;
    }

    /* Loading state */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--text-light);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Badges de conquista */
    .achievement-badge {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--accent-color);
      color: var(--text-dark);
      padding: 20px 30px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 18px;
      box-shadow: var(--shadow-xl);
      z-index: 1001;
      animation: slideInUp 0.6s ease;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-container">
      <img src="https://imgur.com/c5XQ7TW.png" class="logo-eac" alt="Logo EAC">
      <h1 style="font-size: 1.5rem; margin: 0;">Quiz EAC</h1>
    </div>
    <div class="score-display">
      <span class="score-icon">üèÜ</span>
      <span id="score">0</span>
    </div>
  </div>

  <div id="tela">
    <div class="timer-container" id="timer" style="display: none;">
      <span id="timeLeft">30</span>s
    </div>

    <div class="progress-container" style="display: none;" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
      </div>
      <div class="progress-text">
        Pergunta <span id="currentQuestion">1</span> de <span id="totalQuestions">10</span>
      </div>
    </div>

    <div id="content">
      <div class="loading"></div>
      <p>Carregando quiz...</p>
    </div>
  </div>
<script>
  // Vari√°veis globais para gamifica√ß√£o
  let score = 0;
  let streak = 0;
  let currentQuestionIndex = 0;
  let totalQuestions = 0;
  let timeLeft = 30;
  let timerInterval;
  let questions = []; // Vari√°vel de perguntas do Apps Script

  // Elementos DOM
  const ui = document.getElementById('tela');
  const scoreElement = document.getElementById('score');
  const timerElement = document.getElementById('timer');
  const timeLeftElement = document.getElementById('timeLeft');
  const progressContainer = document.getElementById('progressContainer');
  const progressFill = document.getElementById('progressFill');
  const currentQuestionElement = document.getElementById('currentQuestion');
  const totalQuestionsElement = document.getElementById('totalQuestions');
  const contentElement = document.getElementById('content');

  // Vari√°veis globais do Apps Script
  let NOME, QUIZ, PERGS = [];

  // Fun√ß√µes de gamifica√ß√£o
  function updateScore(points) {
    score += points;
    scoreElement.textContent = score;
    scoreElement.parentElement.classList.add('celebration');
    setTimeout(() => {
      scoreElement.parentElement.classList.remove('celebration');
    }, 600);
  }

  function updateProgress() {
    const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
    progressFill.style.width = progress + '%';
    currentQuestionElement.textContent = currentQuestionIndex + 1;
    totalQuestionsElement.textContent = totalQuestions;
  }

  function startTimer() {
    timeLeft = 30; // Resetar tempo
    timeLeftElement.textContent = timeLeft;
    timerElement.style.display = 'block';
    timerElement.classList.remove('timer-urgent');

    clearInterval(timerInterval); // Limpar qualquer timer anterior
    timerInterval = setInterval(() => {
      timeLeft--;
      timeLeftElement.textContent = timeLeft;

      if (timeLeft <= 10) {
        timerElement.classList.add('timer-urgent');
      }

      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        handleTimeUp();
      }
    }, 1000);
  }

  function stopTimer() {
    clearInterval(timerInterval);
    timerElement.style.display = 'none';
  }

  function handleTimeUp() {
    // L√≥gica para quando o tempo acaba - considera resposta incorreta
    showFeedback(false, "Tempo esgotado!");
    const p = PERGS[currentQuestionIndex];
    // Chama choose com um √≠ndice de resposta incorreta (-1 ou null)
    choose(null, p.id, true); // O 'true' indica que foi por tempo esgotado
  }

  function createConfetti() {
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.animationDelay = Math.random() * 3 + 's';
      confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
      document.body.appendChild(confetti);

      setTimeout(() => {
        confetti.remove();
      }, 5000);
    }
  }

  function showFeedback(isCorrect, message) {
    const feedbackContainer = document.createElement('div');
    feedbackContainer.className = `feedback-container ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}`;
    feedbackContainer.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
        <span style="font-size: 24px;">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
      </div>
    `;

    contentElement.appendChild(feedbackContainer);

    if (isCorrect) {
      createConfetti();
      updateScore(100 + (streak * 10));
      streak++;

      if (streak >= 3) {
        showAchievement(`üî• ${streak} acertos seguidos!`);
      }
    } else {
      streak = 0;
    }

    setTimeout(() => {
      feedbackContainer.remove();
    }, 3000);
  }

  function showAchievement(message) {
    const badge = document.createElement('div');
    badge.className = 'achievement-badge';
    badge.textContent = message;
    document.body.appendChild(badge);

    setTimeout(() => {
      badge.remove();
    }, 3000);
  }

  function shareResults() {
    const text = `Acabei de fazer o Quiz EAC e consegui ${score} pontos! üéâ`;
    if (navigator.share) {
      navigator.share({
        title: 'Quiz EAC',
        text: text,
        url: window.location.href
      });
    } else {
      // Fallback para copiar para clipboard
      navigator.clipboard.writeText(text + ' ' + window.location.href);
      showAchievement('Link copiado! üìã');
    }
  }

  // Fun√ß√µes de intera√ß√£o com Google Apps Script
  document.addEventListener('DOMContentLoaded', function() {
      showWelcomeScreen();
  });

  function showWelcomeScreen() {
    contentElement.innerHTML = `
      <h2>Bem-vindo ao Quiz EAC Gamificado! üéÆ</h2>
      <p style="font-size: 1.1rem; margin-bottom: 30px; opacity: 0.9;">
        Teste seus conhecimentos e ganhe pontos! Responda rapidamente para ganhar b√¥nus.
      </p>
      <button class="quiz-button" onclick="loadQuizzesList()">
        üöÄ Come√ßar Quiz
      </button>
    `;
    // Esconder elementos do quiz na tela de boas-vindas
    timerElement.style.display = 'none';
    progressContainer.style.display = 'none';
    scoreElement.textContent = '0';
  }

  function loadQuizzesList() {
    contentElement.innerHTML = `
      <div class="loading"></div>
      <p>Carregando lista de quizzes...</p>
    `;

    google.script.run
      .withSuccessHandler(showQuizzes)
      .withFailureHandler(showError)
      .getQuizzes();
  }

  // ====== SUBSTITU√çDA / ATUALIZADA ======
  function showQuizzes(quizzes) {
    if (!quizzes || quizzes.length === 0) {
      contentElement.innerHTML = `
        <div class="error-message">
          <h3>‚ö†Ô∏è Nenhum quiz encontrado</h3>
          <p>Verifique se existem dados na aba 'quiz_perguntas' da planilha.</p>
          <button class="quiz-button" onclick="reiniciar()">üîô Voltar</button>
        </div>
      `;
      return;
    }

    contentElement.innerHTML = `
      <h2>Selecione um quiz</h2>
      <div class="quiz-grid" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;">
        ${quizzes.map(q => {
          const nomeFormatado = q.nome.replace(/^quiz_/, '').replace(/_/g, ' ').toUpperCase();
          return `
            <div style="display:flex; gap:8px; justify-content:center; align-items:center;">
              <button class="quiz-button" onclick="startQuiz('${q.id}')">‚ñ∂Ô∏è Jogar ‚Äî ${nomeFormatado}</button>
              <button class="quiz-button" style="background:#111827;color:#fff" onclick="showRanking('${q.id}','${nomeFormatado}')">üìä Resultados</button>
            </div>
          `;
        }).join('')}
      </div>
      <div style="margin-top:18px;">
        <button class="quiz-button" onclick="showWelcomeScreen()">üîô In√≠cio</button>
      </div>
    `;
  }

  function startQuiz(q) {
    QUIZ = q;
    do {
      NOME = prompt('Digite seu nome para participar do quiz:');
      if (NOME === null) { // Usu√°rio cancelou
        showWelcomeScreen(); // Volta para a tela de boas-vindas
        return;
      }
      NOME = NOME.trim();
      if (!NOME) alert('Por favor, digite um nome v√°lido!');
    } while (!NOME);

    contentElement.innerHTML = `
      <div class="loading"></div>
      <p>Carregando perguntas do quiz...</p>
    `;

    // Resetar vari√°veis de gamifica√ß√£o ao iniciar um novo quiz
    score = 0;
    streak = 0;
    currentQuestionIndex = 0;
    scoreElement.textContent = '0';
    progressFill.style.width = '0%';
    timerElement.style.display = 'none';
    progressContainer.style.display = 'none';

    google.script.run
      .withSuccessHandler(loadPerguntas)
      .withFailureHandler(showError)
      .getPerguntas(QUIZ);
  }

  function loadPerguntas(pergs) {
    PERGS = pergs;
    currentQuestionIndex = 0;
    totalQuestions = PERGS.length;

    if (!PERGS || PERGS.length === 0) {
      contentElement.innerHTML = `
        <div class="error-message">
          <h3>‚ö†Ô∏è Nenhuma pergunta encontrada</h3>
          <p>Este quiz n√£o possui perguntas cadastradas.</p>
          <button class="quiz-button" onclick="reiniciar()">üîô Voltar aos Quizzes</button>
        </div>
      `;
      return;
    }

    // Mostrar barra de progresso e timer
    progressContainer.style.display = 'block';
    timerElement.style.display = 'block';

    try {
      ask(); // inicia a primeira pergunta
    } catch (err) {
      contentElement.innerHTML = `
        <div class="error-message">
          <h3>‚ùå Erro ao montar pergunta</h3>
          <p>${err.message}</p>
          <button class="quiz-button" onclick="reiniciar()">üîô Tentar novamente</button>
        </div>
      `;
    }
  }

  function ask() {
    if (!PERGS || !Array.isArray(PERGS)) return;

    // Se j√° respondeu tudo, finaliza
    if (currentQuestionIndex >= PERGS.length) {
      finish();
      return;
    }

    const p = PERGS[currentQuestionIndex];

    // Valida√ß√£o da estrutura da pergunta
    if (!p || typeof p.pergunta !== "string" || !Array.isArray(p.opcoes) || p.opcoes.length !== 4 || typeof p.correta !== "number") {
      contentElement.innerHTML = `
        <div class="error-message">
          <h3>‚ùå Erro ao exibir a pergunta</h3>
          <p>A pergunta atual est√° mal formatada ou incompleta.</p>
          <pre style="text-align: left; font-size: 12px;">${JSON.stringify(p, null, 2)}</pre>
          <button class="quiz-button" onclick="reiniciar()">üîÅ Tentar outro quiz</button>
        </div>
      `;
      return;
    }

    // Escapador de caracteres HTML
    const escapeHTML = (str) => String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");

    updateProgress();

    const colors = ['red', 'blue', 'yellow', 'green'];

    const htmlPergunta = `
      <h2>${escapeHTML(p.pergunta)}</h2>
      <div class="options">
        ${p.opcoes.map((opc, i) => `
          <button class="option-button option-${colors[i]}" 
                  data-correct="${i === p.correta}" 
                  onclick="choose(${i}, '${p.id}', false)">
            <span class="option-icon"></span>
            <span>${escapeHTML(opc)}</span>
          </button>
        `).join('')}
      </div>
    `;

    contentElement.innerHTML = htmlPergunta;

    // Garante exibi√ß√£o mesmo se algum CSS quebrar
    contentElement.style.display = 'block';
    contentElement.style.visibility = 'visible';
    contentElement.style.opacity = '1';

    startTimer();
  }

  function choose(indice, idPergunta, isTimeUp = false) {
    // Para o timer imediatamente
    stopTimer();

    const botoes = document.querySelectorAll('.option-button');
    let isCorrect = false;

    // Desativa todos os bot√µes
    botoes.forEach(btn => {
      btn.classList.add('option-disabled');
      btn.style.pointerEvents = 'none';
    });

    // Garante √≠ndice v√°lido (0..botoes.length-1)
    const indiceValido = Number.isInteger(indice) && indice >= 0 && indice < botoes.length;

    if (!isTimeUp && indiceValido) {
      const botaoSelecionado = botoes[indice];
      isCorrect = (botaoSelecionado && botaoSelecionado.dataset.correct === 'true');

      // Feedback visual imediato
      if (isCorrect) {
        botaoSelecionado.classList.add('option-correct');
        showFeedback(true, "Correto! üéâ");
      } else {
        botaoSelecionado.classList.add('option-incorrect');
        showFeedback(false, "Incorreto! üòû");
      }
    } else {
      // Foi por tempo esgotado ou √≠ndice inv√°lido
      isCorrect = false;
      if (isTimeUp) {
        // feedback do tempo j√° foi mostrado em handleTimeUp()
      } else {
        showFeedback(false, "Resposta inv√°lida.");
      }
    }

    // Sempre destaca a alternativa correta
    botoes.forEach(btn => {
      if (btn.dataset.correct === 'true') {
        btn.classList.add('option-correct');
      }
    });

    // Calcula tempo gasto nesta pergunta (base 30s) e envia para o Apps Script
    // timeLeft j√° existe no seu c√≥digo; clamp para garantir 0..30
    const tempoGasto = Math.min(30, Math.max(0, 30 - (Number(timeLeft) || 0)));

    // Se foi por tempo esgotado ou √≠ndice inv√°lido, mandamos null
    const indiceParaSalvar = (isTimeUp || !indiceValido) ? null : indice;

    google.script.run
      .withFailureHandler(showError)
      .saveResposta(NOME, QUIZ, idPergunta, indiceParaSalvar, tempoGasto);

    // Pr√≥xima pergunta ap√≥s pequeno delay para o usu√°rio ver o feedback
    setTimeout(() => {
      currentQuestionIndex++;
      ask();
    }, 3000);
  }


  function finish() {
    contentElement.innerHTML = `
      <div class="loading"></div>
      <p>Calculando seu resultado final...</p>
    `;

    google.script.run
      .withSuccessHandler(showResultadoFinal)
      .withFailureHandler(showError)
      .finalizarQuiz(NOME, QUIZ);
  }

  // ====== ATUALIZADA: agora inclui o bot√£o "Ver Ranking do Quiz" ======
  function showResultadoFinal(resultado) {
    stopTimer();
    progressContainer.style.display = 'none';

    const percentage = (resultado.acertos / resultado.total) * 100;
    let message = '';
    let emoji = '';

    if (percentage >= 90) {
      message = 'Excelente! Voc√™ √© um expert!';
      emoji = 'üèÜ';
      createConfetti();
    } else if (percentage >= 70) {
      message = 'Muito bom! Continue assim!';
      emoji = 'üéâ';
    } else if (percentage >= 50) {
      message = 'Bom trabalho! Pode melhorar!';
      emoji = 'üëç';
    } else {
      message = 'Precisa estudar mais!';
      emoji = 'üìö';
    }

    contentElement.innerHTML = `
      <div style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 20px;">${emoji}</div>
        <h2>Quiz Finalizado!</h2>
        <div style="font-size: 2rem; margin: 20px 0; color: var(--accent-color);">
          ${resultado.acertos} acertos de ${resultado.total} perguntas
        </div>
        <div style="font-size: 1.2rem; margin-bottom: 30px;">
          ${Math.round(percentage)}% de acertos
        </div>
        <p style="font-size: 1.1rem; margin-bottom: 30px;">${message}</p>

        <button class="quiz-button" onclick="reiniciar()">
          üîÑ Jogar Novamente
        </button>
        <button class="quiz-button" onclick="shareResults()" style="background: var(--success-color); color: white;">
          üì± Compartilhar Resultado
        </button>
        <!-- NOVO bot√£o: ver ranking deste quiz -->
        <button class="quiz-button" onclick="showRanking('${QUIZ}')">
          üìä Ver Ranking do Quiz
        </button>
      </div>
    `;
  }

  function showError(error) {
    contentElement.innerHTML = `
      <div class="error-message">
        <h3>Erro ao carregar dados</h3>
        <p>${error.message || error.toString()}</p>
        <button class="quiz-button" onclick="reiniciar()">üîô Voltar</button>
      </div>
    `;
  }

  function reiniciar() {
    // Limpa tudo e volta para a tela de boas-vindas
    score = 0;
    streak = 0;
    currentQuestionIndex = 0;
    totalQuestions = 0;
    PERGS = [];
    NOME = null;
    QUIZ = null;
    stopTimer();
    scoreElement.textContent = '0';
    progressFill.style.width = '0%';
    timerElement.style.display = 'none';
    progressContainer.style.display = 'none';
    showWelcomeScreen();
  }

  // ====== NOVAS: ranking e atividade recente ======

  // Busca ranking do quiz selecionado
  function showRanking(quizId, nomeFormatado = '') {
    contentElement.innerHTML = `
      <div class="loading"></div>
      <p>Carregando resultados...</p>
    `;

    google.script.run
      .withSuccessHandler((dados) => renderRanking(quizId, nomeFormatado, dados))
      .withFailureHandler(showError)
      .getRanking(quizId);
  }

  // Renderiza a tela de ranking e inclui "Atividade recente"
  function renderRanking(quizId, nomeFormatado, ranking) {
    const titulo = nomeFormatado || quizId;

    const tabelaRanking = (!ranking || ranking.length === 0) ? `
      <p style="opacity:.9;margin:8px 0 16px;">Ainda n√£o h√° registros no ranking para este quiz.</p>
    ` : `
      <div style="overflow:auto; margin:12px 0;">
        <table style="width:100%; border-collapse:separate; border-spacing:0; border-radius:12px; overflow:hidden;">
          <thead style="background:rgba(255,255,255,.15);">
            <tr>
              <th style="padding:10px; text-align:center;">#</th>
              <th style="padding:10px; text-align:left;">Nome</th>
              <th style="padding:10px; text-align:center;">Acertos</th>
            </tr>
          </thead>
          <tbody style="background:rgba(255,255,255,.08);">
            ${ranking.map((r,i) => `
              <tr>
                <td style="padding:10px; text-align:center; font-weight:700;">${i + 1}</td>
                <td style="padding:10px;">${r.nome}</td>
                <td style="padding:10px; text-align:center;">${r.pontos}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;

    contentElement.innerHTML = `
      <h2>üìä Resultados ‚Äî ${titulo}</h2>
      ${tabelaRanking}
      <div style="display:flex; gap:8px; justify-content:center; margin:12px 0 24px;">
        <button class="quiz-button" onclick="startQuiz('${quizId}')">‚ñ∂Ô∏è Jogar</button>
        <button class="quiz-button" onclick="loadQuizzesList()">üîô Voltar</button>
        <button class="quiz-button" onclick="showRanking('${quizId}','${nomeFormatado}')">üîÅ Atualizar</button>
      </div>

      <h3 style="margin-top:6px;">üïí Atividade recente</h3>
      <div id="recentActivity" style="margin-top:8px;">
        <div class="loading"></div>
        <p>Carregando atividade...</p>
      </div>
    `;

    // Carrega a atividade recente deste quiz
    google.script.run
      .withSuccessHandler((rows) => {
        const host = document.getElementById('recentActivity');
        if (!rows || !rows.length) {
          host.innerHTML = `<p style="opacity:.9;">Sem atividade recente.</p>`;
          return;
        }
        const linhas = rows.map(r => `
          <tr>
            <td style="padding:8px">${new Date(r.timestamp).toLocaleString()}</td>
            <td style="padding:8px">${r.nome}</td>
            <td style="padding:8px">${r.idPergunta}</td>
            <td style="padding:8px">${r.status}</td>
            <td style="padding:8px">${r.respostaDada}</td>
            <td style="padding:8px">${r.respostaCorreta}</td>
          </tr>
        `).join('');
        host.innerHTML = `
          <div style="overflow:auto;">
            <table style="width:100%;border-collapse:collapse;">
              <thead><tr>
                <th>Quando</th><th>Nome</th><th>Pergunta</th><th>Status</th><th>Dada</th><th>Correta</th>
              </tr></thead>
              <tbody>${linhas}</tbody>
            </table>
          </div>
        `;
      })
      .withFailureHandler(() => {
        const host = document.getElementById('recentActivity');
        host.innerHTML = `<p class="error-message">Falha ao carregar atividade.</p>`;
      })
      .getUltimosResultados(quizId, 30); // fun√ß√£o nova no Apps Script
  }
</script>  
</body>
</html>
