<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>EAC Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --blue-900:#0B2043; --blue-800:#10345f; --blue-700:#1565C0;
      --red-600:#E53935; --gold-500:#f0c419; --green-500:#10b981; --amber-500:#f59e0b;
      --glass: rgba(255,255,255,.14); --glass-border: rgba(255,255,255,.18);
      --text:#fff; --text-dark:#111827;
      --shadow: 0 18px 50px rgba(0,0,0,.35); --radius: 18px;
      --fs-xs: clamp(.82rem, .72rem + .6vw, .95rem); --fs-sm: clamp(.95rem, .9rem + .4vw, 1.05rem);
      --fs-md: clamp(1.05rem, 1rem + .8vw, 1.28rem); --fs-lg: clamp(1.4rem, 1.2rem + 1.4vw, 2.1rem);
      --fs-xl: clamp(2.1rem, 1.7rem + 2.8vw, 3.2rem);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text); background: linear-gradient(180deg, var(--blue-800) 0%, var(--blue-900) 100%);
      min-height:100vh; display:flex; flex-direction:column;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .header{
      position:fixed; inset:0 0 auto 0; height:64px; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; background:rgba(255,255,255,.08);
      backdrop-filter: blur(10px); border-bottom:1px solid var(--glass-border);
    }
    .logo-row{ display:flex; align-items:center; gap:10px; }
    .brand{ font-weight:800; letter-spacing:.3px; }
    .game-info{ display:flex; align-items:center; gap:12px; }
    .player-chip{ font-weight:700; display:flex; align-items:center; gap:6px; }
    .pin-chip{ background:rgba(0,0,0,.3); padding:6px 12px; border-radius:999px; font-weight:800; letter-spacing:1px; }

    .container{ width:100%; max-width:900px; margin:84px auto 24px; padding:0 16px; }
    .card{
      text-align:center; padding:28px;
      background:var(--glass); border:1px solid var(--glass-border);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .btn{
      background:#fff; color:var(--text-dark);
      border:none; border-radius:12px; font-weight:800;
      padding:14px 20px; cursor:pointer; transition:.25s transform, .25s filter;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
    }
    .btn:hover{ transform:translateY(-2px); filter:brightness(1.02); }
    .btn.primary{ background:linear-gradient(135deg,#4f46e5,#06b6d4); color:#fff; }
    .btn.dark{ background:#111827; color:#fff; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; filter:none; }

    .options{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:18px; }
    .option{
      min-height:74px; border-radius:16px; display:flex; align-items:center; justify-content:center; gap:12px;
      color:#fff; font-weight:800; font-size:1rem; cursor:pointer; border:none; position:relative;
      box-shadow:0 12px 28px rgba(0,0,0,.25); transition:transform .2s, filter .2s;
    }
    .option:not(:disabled):hover{ transform:translateY(-2px); filter:brightness(1.05); }
    .option.red{ background:linear-gradient(135deg,#e53e3e,#b91c1c) }
    .option.blue{ background:linear-gradient(135deg,#2563eb,#1e40af) }
    .option.yellow{ background:linear-gradient(135deg,#f59e0b,#b45309); color:#111 }
    .option.green{ background:linear-gradient(135deg,#10b981,#047857) }
    .correct{ background:linear-gradient(135deg,#10b981,#059669)!important; transform: scale(1.05); box-shadow:0 0 0 3px #22d3ee, 0 14px 30px rgba(0,0,0,.35); position:relative; }
    .incorrect{ background:linear-gradient(135deg,#ef4444,#dc2626)!important; opacity:0.6; }
    .disabled{ opacity:.6; pointer-events:none; }
    .answer-badge{ position:absolute; top:8px; right:10px; background:rgba(34,211,238,.18); color:#fff; border:1px solid #22d3ee; border-radius:10px; padding:4px 8px; font-size:.78rem; font-weight:800; letter-spacing:.2px; }

    .input{ width:min(420px, 92vw); padding:12px 14px; border-radius:12px; border:1px solid var(--glass-border); font-size:16px; outline:none; background:rgba(255,255,255,.1); color:#fff; }
    .avatar-grid{ display:grid; gap:8px; grid-template-columns:repeat(auto-fill, 42px); justify-content:center; padding:10px; background:rgba(255,255,255,.08); border:1px solid var(--glass-border); border-radius:12px; max-width:min(420px, 92vw); margin:10px auto; }
    .avatar{ width:42px; height:42px; border-radius:10px; background:#fff; color:#111; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid transparent; transition:.2s transform, .2s border-color; font-size:22px; }
    .avatar:hover{ transform:translateY(-2px) }
    .avatar.selected{ border-color:#22d3ee; }

    .player-list{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:14px; }
    .player-tag{ display:flex; align-items:center; gap:6px; background:rgba(0,0,0,.2); padding:6px 10px; border-radius:8px; }

    .timer{ font-weight:800; background:var(--amber-500); color:#111; padding:12px 20px; border-radius:999px; font-size:1.2rem; }
    .timer.urgent{ background:var(--red-600); color:#fff; animation:pulse .8s infinite; }
    @keyframes pulse{ 0%,100%{ transform:scale(1)} 50%{ transform:scale(1.06)} }

    .table-wrap{ overflow:auto; -webkit-overflow-scrolling:touch; border-radius:12px; margin-top:18px;}
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead{ background:rgba(255,255,255,.15); } tbody{ background:rgba(255,255,255,.08); }
    th,td{ padding:10px; } th{ text-align:left; }

    .hidden{ display:none!important; }
    .section-title{ font-size:var(--fs-lg); margin:0 0 8px; }
    .sub-title{ font-size:var(--fs-md); margin-bottom:12px; opacity:.9; }
    .muted{ opacity:.8; }
    .loader{ display:inline-block; width:24px; height:24px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width:768px){ .options{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo-row">
      <img src="https://imgur.com/c5XQ7TW.png" alt="EAC" style="width:44px; height:44px; border-radius:10px;">
      <div class="brand">EAC Quiz</div>
    </div>
    <div id="header-info" class="game-info hidden">
      <div id="player-info" class="player-chip"></div>
      <div id="pin-info" class="pin-chip"></div>
    </div>
  </header>

  <main class="container">
    <div id="loading" class="card"><div class="loader"></div> <p>Carregando...</p></div>

    <!-- Tela Inicial: Escolher modo -->
    <section id="screen-home" class="card hidden">
      <h1>Bem-vindo ao EAC Quiz!</h1>
      <p class="sub-title">Jogue com seus amigos em tempo real.</p>
      <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
        <button class="btn" onclick="initPlayer()">üôã‚Äç‚ôÇÔ∏è Entrar no Jogo</button>
        <button class="btn primary" onclick="initHost()">üëë Criar Sala</button>
        <button class="btn dark" onclick="showScreen('settings')">‚öôÔ∏è Configura√ß√µes</button>
      </div>
    </section>

    <!-- Tela de Configura√ß√µes -->
    <section id="screen-settings" class="card hidden">
      <h2 class="section-title">Configura√ß√µes do Jogo</h2>
      <div style="display: grid; gap: 20px; max-width: 350px; margin: 20px auto; text-align: left;">
        <div>
          <label for="setting-time-per-question" style="display: block; margin-bottom: 8px; font-weight: 600;">Tempo por Pergunta (segundos)</label>
          <input id="setting-time-per-question" class="input" type="number" value="40" min="10" max="120" style="text-align: center;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Modo de Avan√ßo no Placar</label>
          <div style="display:flex; gap: 10px; justify-content: center;">
             <label style="flex:1; padding: 10px; border-radius: 8px; background: rgba(255,255,255,.1); cursor:pointer;"><input type="radio" name="setting-game-mode" value="automatico" checked> Autom√°tico</label>
             <label style="flex:1; padding: 10px; border-radius: 8px; background: rgba(255,255,255,.1); cursor:pointer;"><input type="radio" name="setting-game-mode" value="manual"> Manual</label>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:12px; justify-content:center; margin-top: 20px;">
        <button class="btn" onclick="showScreen('home')">Voltar</button>
        <button class="btn primary" onclick="saveSettings()">üíæ Salvar e Voltar</button>
      </div>
    </section>


    <!-- Tela do Anfitri√£o: Escolher Quiz -->
    <section id="screen-host-quiz-select" class="card hidden">
      <h2 class="section-title">Escolha um Quiz para Come√ßar</h2>
      <div id="host-quiz-list" class="muted">Carregando quizzes...</div>
      <button class="btn" style="margin-top:22px" onclick="showScreen('home')">Voltar</button>
    </section>

    <!-- Tela do Anfitri√£o: Lobby -->
    <section id="screen-host-lobby" class="card hidden">
      <h2 class="section-title">Sala de Espera</h2>
      <p class="sub-title">Pe√ßa para os jogadores inserirem o PIN:</p>
      <div id="host-pin-display" style="font-size:var(--fs-xl); font-weight:800; letter-spacing:4px; margin-bottom:18px;">- - - -</div>
      <h3 class="section-title" style="font-size:1.1rem">Jogadores Conectados (<span id="host-player-count">0</span>)</h3>
      <div id="host-player-list" class="player-list">
        <p class="muted">Aguardando jogadores...</p>
      </div>
      <div style="margin-top:22px; display:flex; gap:12px; justify-content:center;">
        <button class="btn" onclick="showScreen('home')">Cancelar</button>
        <button id="start-game-btn" class="btn primary" onclick="host_startGame()" disabled>‚ñ∂Ô∏è Iniciar Jogo</button>
      </div>
    </section>

    <!-- Tela do Jogador: Entrar no jogo -->
    <section id="screen-player-join" class="card hidden">
      <h2 class="section-title">Entrar no Jogo</h2>
      <div style="display:grid; gap:14px; justify-items:center;">
        <input id="pin-input" class="input" placeholder="PIN do Jogo" style="letter-spacing:3px; text-align:center;">
        <input id="name-input" class="input" placeholder="Seu nome" maxlength="40">
        <div id="player-avatar-grid" class="avatar-grid"></div>
        <div style="display:flex; gap:10px; justify-content:center;">
          <button class="btn" onclick="showScreen('home')">Voltar</button>
          <button class="btn primary" onclick="player_joinGame()">üöÄ Entrar</button>
        </div>
      </div>
    </section>

    <!-- Tela do Jogador: Lobby -->
    <section id="screen-player-lobby" class="card hidden">
      <h2 class="section-title">Voc√™ entrou!</h2>
      <p class="sub-title">Aguardando o anfitri√£o iniciar o jogo...</p>
      <div class="loader"></div>
      <h3 class="section-title" style="font-size:1.1rem; margin-top:22px;">Jogadores na sala:</h3>
      <div id="player-lobby-list" class="player-list"></div>
    </section>

    <!-- Tela da Pergunta (comum para Host e Player) -->
    <section id="screen-question" class="card hidden" style="position:relative; padding-top:48px;">
        <div id="game-timer" class="timer" style="position:absolute; top:16px; left:16px;">40</div>
        <small style="position:absolute; top:22px; right:16px;" id="question-progress">1 / 10</small>
        
        <h2 id="question-text" class="section-title" style="margin-top:12px;">Carregando pergunta...</h2>
        
        <div style="position: relative;">
          <div id="question-options" class="options"></div>
          <div id="answer-reveal-feedback" class="hidden" style="position: absolute; inset: 0; background: rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; text-align:center;"></div>
        </div>

        <!-- Info para o Host -->
        <div id="host-question-info" class="hidden" style="margin-top:18px;">
          <p><span id="host-answer-count">0</span> de <span id="host-total-players">0</span> jogadores responderam.</p>
          <div id="host-action-container"></div>
        </div>
    </section>

    <!-- Tela do Placar -->
    <section id="screen-leaderboard" class="card hidden">
      <div id="player-feedback-result" style="margin-bottom: 12px;"></div>
      <h2 class="section-title">Placar da Rodada</h2>
      <div id="leaderboard-correct-answer" class="muted" style="margin-bottom:12px;"></div>
      <div class="table-wrap">
        <table id="leaderboard-table">
          <thead><tr><th>#</th><th>Nome</th><th>Pontua√ß√£o</th><th>Acertos</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <!-- Bot√£o para o Host -->
      <div id="host-leaderboard-info" class="hidden" style="margin-top:18px;">
        <p id="leaderboard-countdown"></p>
        <button id="manual-next-btn" class="btn primary" onclick="host_next()">Pr√≥xima Pergunta</button>
      </div>
    </section>

    <!-- Tela Final -->
    <section id="screen-final" class="card hidden">
      <h2 class="section-title">Fim de Jogo! üèÜ</h2>
      <div id="podium-container" style="margin: 20px 0;"></div>
      <h3 class="section-title" style="font-size:1.2rem; margin-top: 12px;">Placar Final</h3>
       <div class="table-wrap">
        <table id="final-leaderboard-table">
          <thead><tr><th>#</th><th>Nome</th><th>Pontua√ß√£o</th><th>Acertos</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="btn" style="margin-top:22px;" onclick="showScreen('home')">Voltar ao In√≠cio</button>
    </section>

    <!-- Overlay de Erro/Info -->
    <div id="toast" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--red-600); color:#fff; padding:20px 30px; border-radius:18px; z-index:100; opacity:0; transition:opacity .3s; pointer-events:none; font-size: var(--fs-lg); font-weight: 700; text-align: center;"></div>

  </main>

<script>
  // ===================================
  // Estado Global do Cliente
  // ===================================
  let ROLE = null; // 'host' ou 'player'
  let GAME_PIN = null;
  let PLAYER_NAME = null;
  let PLAYER_AVATAR = 'üòé';
  let HOST_ID = null;
  
  let pollInterval = null;
  let localTimerInterval = null;
  let leaderboardTimerInterval = null; // Timer para o placar
  let currentQuestionIndexForTimer = -1;
  let quizzesCache = [];
  let timerExpired = false;
  let gameState = {}; // Armazena o estado mais recente
  let SETTINGS = { tempo: 40, modo: 'automatico' };

  const AVATARS = ['üòé','ü§©','üòá','üß†','‚ö°','üî•','üéØ','üê±','üê∂','üêº','üê∏','üêµ','ü¶ä','ü¶Å','üêØ','üê®','ü¶Ñ','üê≤'];
  const OPTION_COLORS = ['red', 'blue', 'yellow', 'green'];

  // ===================================
  // Inicializa√ß√£o e Gerenciamento de Tela
  // ===================================
  
  document.addEventListener('DOMContentLoaded', () => {
    // Carrega settings
    const savedSettings = localStorage.getItem('EAC_QUIZ_SETTINGS');
    if (savedSettings) {
      try { SETTINGS = JSON.parse(savedSettings); } catch(e){}
    }
    document.getElementById('setting-time-per-question').value = SETTINGS.tempo;
    document.querySelector(`input[name="setting-game-mode"][value="${SETTINGS.modo}"]`).checked = true;

    // Carrega dados do jogador
    const savedPlayer = localStorage.getItem('EAC_LOBBY');
    if (savedPlayer) {
      try {
        const o = JSON.parse(savedPlayer);
        PLAYER_NAME = o.nome || '';
        PLAYER_AVATAR = o.avatar || 'üòé';
      } catch(e){}
    }
    showScreen('home');
  });

  function saveSettings() {
    SETTINGS.tempo = document.getElementById('setting-time-per-question').value;
    SETTINGS.modo = document.querySelector('input[name="setting-game-mode"]:checked').value;
    localStorage.setItem('EAC_QUIZ_SETTINGS', JSON.stringify(SETTINGS));
    showToast('Configura√ß√µes salvas!', false);
    showScreen('home');
  }
  
  function showScreen(screenName) {
    document.getElementById('loading').classList.add('hidden');
    document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
    document.getElementById(`screen-${screenName}`).classList.remove('hidden');

    // Limpa o estado do jogo ao voltar para a home
    if (screenName === 'home') {
      clearInterval(pollInterval);
      clearInterval(localTimerInterval);
      clearInterval(leaderboardTimerInterval);
      ROLE = null; GAME_PIN = null; HOST_ID = null;
      document.getElementById('header-info').classList.add('hidden');
    }
  }

  function showToast(message, isError = true) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.background = isError ? 'var(--red-600)' : 'var(--green-500)';
    toast.style.opacity = '1';
    setTimeout(() => { toast.style.opacity = '0'; }, 3000);
  }

  function setLoading(message = 'Aguarde...') {
    document.querySelectorAll('.btn').forEach(b => b.disabled = true);
    console.log(`Loading: ${message}`);
  }

  function clearLoading() {
    document.querySelectorAll('.btn').forEach(b => b.disabled = false);
    console.log('Loading finished.');
  }

  // ===================================
  // Fluxo do Anfitri√£o (Host)
  // ===================================

  function initHost() {
    ROLE = 'host';
    showScreen('host-quiz-select');
    setLoading('Carregando quizzes...');
    google.script.run
      .withSuccessHandler(quizzes => {
        clearLoading();
        quizzesCache = quizzes || [];
        const listEl = document.getElementById('host-quiz-list');
        if (!quizzes.length) {
          listEl.innerHTML = '<p>Nenhum quiz encontrado na planilha.</p>';
          return;
        }
        listEl.innerHTML = quizzes.map(q => 
          `<button class="btn" style="margin:5px;" onclick="host_createGame('${q.id}')">${q.nome.replace(/^quiz_/,'').replace(/_/g,' ')}</button>`
        ).join('');
      })
      .withFailureHandler(err => { clearLoading(); showToast(err.message); })
      .getQuizzes();
  }
  
  function host_createGame(quizId) {
    const timePerQuestion = SETTINGS.tempo;
    const gameMode = SETTINGS.modo;
    setLoading('Criando sala...');
    google.script.run
      .withSuccessHandler(result => {
        clearLoading();
        GAME_PIN = result.pin;
        HOST_ID = result.hostId;
        document.getElementById('host-pin-display').textContent = GAME_PIN;
        document.getElementById('header-info').classList.remove('hidden');
        document.getElementById('player-info').innerHTML = `üëë Anfitri√£o`;
        document.getElementById('pin-info').textContent = `PIN: ${GAME_PIN}`;
        showScreen('host-lobby');
        startPolling();
      })
      .withFailureHandler(err => { clearLoading(); showToast(err.message); })
      .createGameSession(quizId, timePerQuestion, gameMode);
  }

  function host_startGame() {
    setLoading('Iniciando jogo...');
    google.script.run
      .withSuccessHandler(() => { clearLoading(); /* O polling far√° o resto */ })
      .withFailureHandler(err => { clearLoading(); showToast(err.message); })
      .startGame(GAME_PIN, HOST_ID);
  }

  function host_next() {
    setLoading('Avan√ßando...');
    google.script.run
      .withSuccessHandler(() => { clearLoading(); /* O polling far√° o resto */ })
      .withFailureHandler(err => { clearLoading(); showToast(err.message); })
      .nextGameState(GAME_PIN, HOST_ID);
  }
  
  // ===================================
  // Fluxo do Jogador (Player)
  // ===================================

  function initPlayer() {
    ROLE = 'player';
    showScreen('player-join');
    const nameInput = document.getElementById('name-input');
    nameInput.value = PLAYER_NAME || '';
    
    const avatarGrid = document.getElementById('player-avatar-grid');
    avatarGrid.innerHTML = AVATARS.map(a => 
      `<button class="avatar ${a === PLAYER_AVATAR ? 'selected' : ''}" data-v="${a}" onclick="selectAvatar(this)">${a}</button>`
    ).join('');
  }

  function selectAvatar(btn) {
    PLAYER_AVATAR = btn.dataset.v;
    document.querySelectorAll('.avatar').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
  }

  function player_joinGame() {
    const pin = document.getElementById('pin-input').value.trim();
    const name = document.getElementById('name-input').value.trim();

    if (!pin || !name) {
      showToast('PIN e Nome s√£o obrigat√≥rios.');
      return;
    }

    GAME_PIN = pin;
    PLAYER_NAME = name;
    localStorage.setItem('EAC_LOBBY', JSON.stringify({ nome: PLAYER_NAME, avatar: PLAYER_AVATAR }));

    setLoading('Entrando na sala...');
    google.script.run
      .withSuccessHandler(state => {
        clearLoading();
        gameState = state;
        document.getElementById('header-info').classList.remove('hidden');
        document.getElementById('player-info').innerHTML = `${PLAYER_AVATAR} ${PLAYER_NAME}`;
        document.getElementById('pin-info').textContent = `PIN: ${GAME_PIN}`;
        showScreen('player-lobby');
        startPolling();
      })
      .withFailureHandler(err => {
        clearLoading();
        showToast(err.message);
      })
      .joinGame(GAME_PIN, PLAYER_NAME, PLAYER_AVATAR);
  }
  
  function player_submitAnswer(answerIdx) {
    setLoading('Enviando resposta...');
    
    // Desabilita op√ß√µes para evitar m√∫ltiplos envios
    document.querySelectorAll('#question-options .option').forEach(btn => btn.disabled = true);
    
    // Calcula o tempo gasto baseado no timer local
    const timeLeft = parseInt(document.getElementById('game-timer').textContent || '0');
    const timeSpent = (gameState.tempoPorPergunta || 40) - timeLeft;

    google.script.run
      .withSuccessHandler(result => {
        clearLoading();
        showToast(`+${result.pointsEarned} pontos!`, false);
        // A UI agora mostrar√° um estado de "espera" at√© o pr√≥ximo estado do jogo
      })
      .withFailureHandler(err => {
        clearLoading();
        showToast(err.message);
      })
      .submitAnswer(GAME_PIN, PLAYER_NAME, answerIdx, timeSpent);
  }
  
  // ===================================
  // Polling e Renderiza√ß√£o
  // ===================================

  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => {
      if (!GAME_PIN) {
        clearInterval(pollInterval);
        return;
      }
      google.script.run
        .withSuccessHandler(state => {
          if (state) {
            gameState = state; // Atualiza o estado global
            render(state);
          } else {
            // Jogo n√£o existe mais ou expirou
            showToast('A sess√£o do jogo foi encerrada.');
            showScreen('home');
          }
        })
        .withFailureHandler(err => {
          console.error("Polling error:", err);
          // showToast("Erro de conex√£o. Tentando novamente...");
        })
        .getGameState(GAME_PIN);
    }, 2000); // Poll a cada 2 segundos
  }

  function render(state) {
    // Rota principal baseada no status do jogo
    switch (state.status) {
      case 'LOBBY':
        renderLobby(state);
        break;
      case 'QUESTION':
        renderQuestion(state);
        break;
      case 'ANSWER_REVEAL':
        renderAnswerReveal(state);
        break;
      case 'LEADERBOARD':
        renderLeaderboard(state);
        break;
      case 'FINAL':
        renderFinal(state);
        break;
    }
  }

  function renderLobby(state) {
    const playerNames = Object.keys(state.players || {});
    const playerTags = playerNames.map(nome => {
      const player = state.players[nome];
      return `<div class="player-tag">${player.avatar} ${escapeHtml(nome)}</div>`
    }).join('');
    
    if (ROLE === 'host') {
      showScreen('host-lobby');
      document.getElementById('host-player-count').textContent = playerNames.length;
      document.getElementById('host-player-list').innerHTML = playerNames.length ? playerTags : '<p class="muted">Aguardando jogadores...</p>';
      document.getElementById('start-game-btn').disabled = playerNames.length === 0;
    } else { // Player
      showScreen('player-lobby');
      document.getElementById('player-lobby-list').innerHTML = playerNames.length ? playerTags : '';
    }
  }

  function renderQuestion(state) {
    showScreen('question');

    // Limpa o overlay de feedback da rodada anterior para nÔøΩo bloquear a nova pergunta
    const feedbackEl = document.getElementById('answer-reveal-feedback');
    feedbackEl.classList.add('hidden');
    feedbackEl.innerHTML = '';

    // Garante que o timer seja iniciado apenas UMA VEZ por pergunta
    if (state.currentQuestionIndex !== currentQuestionIndexForTimer) {
      currentQuestionIndexForTimer = state.currentQuestionIndex;
      timerExpired = false;
      clearInterval(leaderboardTimerInterval); // Limpa o timer do placar anterior

      // Inicia um novo timer usando o tempo do SERVIDOR como refer√™ncia.
      updateLocalTimer(state.questionStartTime, state.tempoPorPergunta);
    }
    
    const question = state.perguntas[state.currentQuestionIndex];
    document.getElementById('question-text').textContent = question.pergunta;
    document.getElementById('question-progress').textContent = `${state.currentQuestionIndex + 1} / ${state.perguntas.length}`;
    
    // Verifica se o jogador J√Å respondeu esta pergunta
    const myAnswer = state.answers[PLAYER_NAME];

    const optionsEl = document.getElementById('question-options');
    optionsEl.innerHTML = question.opcoes.map((opt, i) =>
      `<button id="option-${i}" class="option ${OPTION_COLORS[i]}" onclick="player_submitAnswer(${i})">
        <span>${escapeHtml(opt)}</span>
      </button>`
    ).join('');

    if (ROLE === 'host') {
      document.getElementById('host-question-info').classList.remove('hidden');
      document.querySelectorAll('#question-options .option').forEach(b => b.disabled = true);
      document.getElementById('host-answer-count').textContent = Object.keys(state.answers).length;
      document.getElementById('host-total-players').textContent = Object.keys(state.players).length;
      document.getElementById('host-action-container').innerHTML = '';
    } else { // Player
      document.getElementById('host-question-info').classList.add('hidden');
      if (myAnswer !== undefined) {
        // Se j√° respondeu, desabilita tudo e mostra a escolha
        document.querySelectorAll('#question-options .option').forEach((btn, i) => {
          btn.disabled = true;
          if (i !== myAnswer.respostaIdx) btn.classList.add('disabled');
        });
      }
    }
  }
  
  function updateLocalTimer(startTime, questionTime) {
    clearInterval(localTimerInterval);
    const timerEl = document.getElementById('game-timer');
    const time = parseInt(questionTime, 10) || 40;
    
    function update() {
      const elapsed = (Date.now() - startTime) / 1000;
      const timeLeft = Math.max(0, Math.floor(time - elapsed));
      timerEl.textContent = timeLeft;
      timerEl.classList.toggle('urgent', timeLeft <= 10);
      
      if (timeLeft <= 0 && !timerExpired) {
        timerExpired = true; // Previne m√∫ltiplas chamadas
        clearInterval(localTimerInterval); // Para o timer local
        if (ROLE === 'host') {
          // O host √© respons√°vel por avan√ßar para o pr√≥ximo estado (revelar resposta)
          // Adicionamos um pequeno delay para garantir que os clientes processem o "tempo esgotado"
          setTimeout(() => host_next(), 500);
        }
        // Para todos (incluindo jogador), desabilita as op√ß√µes para indicar que o tempo acabou
        document.querySelectorAll('#question-options .option').forEach(btn => btn.disabled = true);
      }
    }
    update();
    localTimerInterval = setInterval(update, 1000);
  }

  function renderAnswerReveal(state) {
    showScreen('question');
    clearInterval(localTimerInterval);

    // Garante que o timer pare em 0
    document.getElementById('game-timer').textContent = '0';
    
    // Mostra a pergunta e as op√ß√µes desabilitadas
    const question = state.perguntas[state.currentQuestionIndex];
    document.getElementById('question-text').textContent = question.pergunta;
    document.getElementById('question-progress').textContent = `${state.currentQuestionIndex + 1} / ${state.perguntas.length}`;
    
    const correctAnswerIdx = state.lastCorrectAnswer;
    const optionsEl = document.getElementById('question-options');
    optionsEl.innerHTML = question.opcoes.map((opt, i) => {
      const isCorrect = i === correctAnswerIdx;
      const badge = isCorrect ? '<span class="answer-badge">Correta</span>' : '';
      return `<button id="option-${i}" class="option ${OPTION_COLORS[i]}" disabled>
        ${badge}
        <span>${escapeHtml(opt)}</span>
      </button>`;
    }).join('');

    // Destaca a resposta correta e a incorreta do jogador
    const myLastAnswer = state.lastAnswers ? state.lastAnswers[PLAYER_NAME] : undefined;

    document.querySelectorAll('#question-options .option').forEach((btn, i) => {
      if (i === correctAnswerIdx) {
        btn.classList.add('correct');
      } else {
        btn.classList.add('disabled');
      }
      if (myLastAnswer !== undefined && myLastAnswer.respostaIdx === i && i !== correctAnswerIdx) {
        btn.classList.add('incorrect');
      }
    });
    
    // Monta e exibe a mensagem de feedback
    const feedbackEl = document.getElementById('answer-reveal-feedback');
    feedbackEl.classList.remove('hidden');
    let feedbackHTML = '';

    if (myLastAnswer !== undefined) {
      if (myLastAnswer.respostaIdx === correctAnswerIdx) {
        feedbackHTML = `<h2 style="color:var(--green-500)">Correto!</h2><p>+${myLastAnswer.points} pontos</p>`;
      } else {
        feedbackHTML = `<h2 style="color:var(--red-600)">Incorreto!</h2>`;
      }
    } else {
      feedbackHTML = `<h2 style="color:var(--amber-500)">Tempo Esgotado!</h2>`;
    }
    feedbackEl.innerHTML = feedbackHTML;

    // O anfitri√£o agenda a pr√≥xima transi√ß√£o
    if (ROLE === 'host') {
      document.getElementById('host-question-info').classList.remove('hidden'); // Show info panel
      const hostActionContainer = document.getElementById('host-action-container');

      if (state.modoDeJogo === 'automatico') {
        hostActionContainer.innerHTML = '<p class="muted">Mostrando placar em 5s...</p>';
        setTimeout(() => host_next(), 5000); // 5 segundos para mostrar a resposta
      } else {
        hostActionContainer.innerHTML = '<button class="btn primary" onclick="host_next()">üìä Mostrar Placar</button>';
      }
    }
  }

  function renderLeaderboard(state) {
    showScreen('leaderboard');
    clearInterval(localTimerInterval); // Para o timer da pergunta
    clearInterval(leaderboardTimerInterval); // Limpa o timer anterior, se houver

    // Feedback para o jogador
    const feedbackEl = document.getElementById('player-feedback-result');
    if (ROLE === 'player') {
      const myLastAnswer = state.lastAnswers ? state.lastAnswers[PLAYER_NAME] : undefined;
      const correctAnswerIdx = state.lastCorrectAnswer;
      
      if (myLastAnswer !== undefined) {
        if (myLastAnswer.respostaIdx === correctAnswerIdx) {
          feedbackEl.innerHTML = `<h3 style="color:var(--green-500)">Correto! (+${myLastAnswer.points} pontos)</h3>`;
        } else {
          feedbackEl.innerHTML = `<h3 style="color:var(--red-600)">Incorreto!</h3>`;
        }
      } else {
        feedbackEl.innerHTML = `<h3 style="color:var(--amber-500)">Tempo esgotado!</h3>`;
      }
    } else {
      feedbackEl.innerHTML = '';
    }

    // Mostra a resposta correta da pergunta anterior
    const question = state.perguntas[state.currentQuestionIndex];
    const correctAnswerIdx = state.lastCorrectAnswer;
    const correctAnswerText = question.opcoes[correctAnswerIdx];
    document.getElementById('leaderboard-correct-answer').innerHTML = `Resposta correta: <b>${escapeHtml(correctAnswerText)}</b>`;
    
    const tableBody = document.querySelector('#leaderboard-table tbody');
    tableBody.innerHTML = state.leaderboard.map((p, i) =>
      `<tr style="${p.nome === PLAYER_NAME ? 'background:rgba(255,255,255,.2);' : ''}">
        <td style="text-align:center;font-weight:bold;">${i + 1}</td>
        <td>${p.avatar} ${escapeHtml(p.nome)}</td>
        <td style="text-align:center;">${p.score}</td>
        <td style="text-align:center;">${p.correctCount ?? 0}</td>
      </tr>`
    ).join('');

    // L√≥gica de avan√ßo (autom√°tico vs manual)
    if (ROLE === 'host') {
      const isLastQuestion = state.currentQuestionIndex >= state.perguntas.length - 1;
      const finalButtonText = 'üèÅ Ver Resultado Final';
      const nextButtonText = '‚ñ∂Ô∏è Pr√≥xima Pergunta';
      
      document.getElementById('host-leaderboard-info').classList.remove('hidden');

      if (state.modoDeJogo === 'automatico') {
        document.getElementById('manual-next-btn').classList.add('hidden');
        const countdownEl = document.getElementById('leaderboard-countdown');
        countdownEl.classList.remove('hidden');

        let countdown = 10;
        const message = isLastQuestion ? 'Exibindo resultado final em ' : 'Pr√≥xima pergunta em ';

        const updateCountdown = () => {
            countdownEl.textContent = message + countdown + 's...';
            countdown--;
            if (countdown < 0) clearInterval(leaderboardTimerInterval);
        };
        
        updateCountdown();
        leaderboardTimerInterval = setInterval(updateCountdown, 1000);
        
        setTimeout(() => {
          clearInterval(leaderboardTimerInterval); 
          host_next();
        }, 10000);

      } else { // Modo Manual
        document.getElementById('leaderboard-countdown').classList.add('hidden');
        const manualBtn = document.getElementById('manual-next-btn');
        manualBtn.textContent = isLastQuestion ? finalButtonText : nextButtonText;
        manualBtn.classList.remove('hidden');
      }
    } else { // Player
      document.getElementById('host-leaderboard-info').classList.add('hidden');
    }
  }

  function renderFinal(state) {
    showScreen('final');
    clearInterval(pollInterval);
    clearInterval(localTimerInterval);
    clearInterval(leaderboardTimerInterval);

    // Renderiza o p√≥dio
    document.getElementById('podium-container').innerHTML = renderPodium(state.leaderboard);

    // Renderiza a tabela completa
    const tableBody = document.querySelector('#final-leaderboard-table tbody');
    tableBody.innerHTML = state.leaderboard.map((p, i) => {
      let medal = '';
      if (i === 0) medal = 'ü•á';
      if (i === 1) medal = 'ü•à';
      if (i === 2) medal = 'ü•â';
      return `<tr style="${p.nome === PLAYER_NAME ? 'background:rgba(255,255,255,.2);' : ''}">
        <td style="text-align:center;font-weight:bold;">${medal} ${i + 1}</td>
        <td>${p.avatar} ${escapeHtml(p.nome)}</td>
        <td style="text-align:center;">${p.score}</td>
        <td style="text-align:center;">${p.correctCount ?? 0}</td>
      </tr>`
    }).join('');
  }

  function renderPodium(ranking) {
      const places = (ranking || []).slice(0, 3);
      const podiumOrder = [1, 0, 2]; // 2nd, 1st, 3rd

      const podiumHTML = podiumOrder.map(i => {
          if (i >= places.length) return '<div class="podio-col"></div>';
          const p = places[i];
          const acertos = p.correctCount ?? 0;
          const placeDetails = {
              height: i === 1 ? '160px' : (i === 0 ? '130px' : '100px'),
              color: i === 1 ? 'var(--gold-500)' : (i === 0 ? '#c0c6cf' : '#d59b6a'),
              label: i === 1 ? 'ü•á 1¬∫ Lugar' : (i === 0 ? 'ü•à 2¬∫ Lugar' : 'ü•â 3¬∫ Lugar')
          };
          return `
              <div class="podio-col" style="display:flex; flex-direction:column; align-items:center; text-align:center;">
                  <div style="font-weight:700;">${p.avatar} ${escapeHtml(p.nome)}</div>
                  <div style="font-size: var(--fs-sm); opacity: .8;">${p.score} pts ¬∑ ${acertos} acerto${acertos === 1 ? '' : 's'}</div>
                  <div style="height:${placeDetails.height}; width: 80%; background:${placeDetails.color}; border-radius:12px 12px 0 0; display:flex; align-items:center; justify-content:center; font-weight:800; color:var(--text-dark); margin-top:8px;">
                      ${acertos}
                  </div>
              </div>
          `;
      }).join('');
      return `<div style="display:grid; grid-template-columns: repeat(3, 1fr); align-items:flex-end; gap:10px; min-height: 220px;">${podiumHTML}</div>`;
  }
  
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'})[m]);
  }

</script>
</body>
</html>

