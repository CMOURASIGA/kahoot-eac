<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>EAC Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --blue-900:#0B2043;
      --blue-800:#10345f;
      --blue-700:#1565C0;
      --red-600:#E53935;
      --gold-500:#f0c419;
      --green-500:#10b981;
      --amber-500:#f59e0b;
      --glass: rgba(255,255,255,.14);
      --glass-border: rgba(255,255,255,.18);
      --text:#fff;
      --text-dark:#111827;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;

      --fs-xs: clamp(.82rem, .72rem + .6vw, .95rem);
      --fs-sm: clamp(.95rem, .9rem + .4vw, 1.05rem);
      --fs-md: clamp(1.05rem, 1rem + .8vw, 1.28rem);
      --fs-lg: clamp(1.4rem, 1.2rem + 1.4vw, 2.1rem);
      --fs-xl: clamp(2.1rem, 1.7rem + 2.8vw, 3.2rem);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, var(--blue-800) 0%, var(--blue-900) 100%);
      min-height:100vh;
      display:flex; flex-direction:column;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    .header{
      position:fixed; inset:0 0 auto 0; height:64px; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; background:rgba(255,255,255,.08);
      backdrop-filter: blur(10px); border-bottom:1px solid var(--glass-border);
    }
    .logo-row{ display:flex; align-items:center; gap:10px; }
    .logo-eac{ width:44px; height:44px; border-radius:10px; object-fit:cover; }
    .brand{ font-weight:800; letter-spacing:.3px; }

    .score-chip{
      background:rgba(255,255,255,.2); border:1px solid var(--glass-border);
      padding:6px 12px; border-radius:999px; font-weight:800; display:flex; align-items:center; gap:8px;
    }

    /* Container */
    .container{ width:100%; max-width:900px; margin:84px auto 24px; padding:0 16px; }

    /* Hero */
    .hero{
      text-align:center; padding:36px 18px 22px;
      background:var(--glass); border:1px solid var(--glass-border);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .hero h1{ font-size:var(--fs-xl); line-height:1.1; margin:8px 0 8px; }
    .hero .sub{ font-size:var(--fs-md); opacity:.92; }

    .hero-cta{ margin:26px 0 12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn{
      background:#fff; color:var(--text-dark);
      border:none; border-radius:12px; font-weight:800;
      padding:14px 20px; cursor:pointer; transition:.25s transform, .25s filter;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
    }
    .btn:hover{ transform:translateY(-2px); filter:brightness(1.02); }
    .btn.primary{ background:linear-gradient(135deg,#4f46e5,#06b6d4); color:#fff; }
    .btn.dark{ background:#111827; color:#fff; }

    .stats{ display:flex; gap:18px; justify-content:center; opacity:.95; margin-top:6px; }
    .stat b{ display:block; font-size:1.35rem; }

    /* Card principal */
    #tela{
      margin-top:18px; background:var(--glass); border:1px solid var(--glass-border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:28px; position:relative; overflow:hidden;
    }

    /* Progresso + timer */
    .progress{ margin-bottom:18px; }
    .bar{ height:12px; background:rgba(255,255,255,.2); border-radius:6px; overflow:hidden; }
    .fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--green-500), var(--amber-500)); transition:width .4s ease; }
    .progress small{ display:block; margin-top:8px; opacity:.9; }

    .timer{ position:absolute; top:16px; right:16px; background:var(--amber-500); color:#111;
      font-weight:800; padding:6px 10px; border-radius:999px; min-width:56px; text-align:center; }
    .timer.urgent{ background:var(--red-600); color:#fff; animation:pulse .8s infinite; }
    @keyframes pulse{ 0%,100%{ transform:scale(1)} 50%{ transform:scale(1.06)} }

    /* Op√ß√µes */
    .options{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:18px; }
    .option{
      min-height:74px; border-radius:16px; display:flex; align-items:center; justify-content:center; gap:12px;
      color:#fff; font-weight:800; font-size:1rem; cursor:pointer; border:none;
      box-shadow:0 12px 28px rgba(0,0,0,.25); transition:transform .2s, filter .2s;
    }
    .option:hover{ transform:translateY(-2px); filter:brightness(1.05); }
    .option.red{ background:linear-gradient(135deg,#e53e3e,#b91c1c) }
    .option.blue{ background:linear-gradient(135deg,#2563eb,#1e40af) }
    .option.yellow{ background:linear-gradient(135deg,#f59e0b,#b45309); color:#111 }
    .option.green{ background:linear-gradient(135deg,#10b981,#047857) }
    .correct{ background:linear-gradient(135deg,#10b981,#059669)!important; }
    .incorrect{ background:linear-gradient(135deg,#ef4444,#dc2626)!important; }
    .disabled{ opacity:.6; pointer-events:none; }

    .feedback{ margin-top:16px; padding:14px; border-radius:12px; font-weight:700; }
    .ok{ background:rgba(16,185,129,.2); border:1px solid #10b981; color:#10b981; }
    .err{ background:rgba(239,68,68,.2); border:1px solid #ef4444; color:#ef4444; }

    /* Tabela */
    .table-wrap{ overflow:auto; -webkit-overflow-scrolling:touch; border-radius:12px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead{ background:rgba(255,255,255,.15); }
    tbody{ background:rgba(255,255,255,.08); }
    th,td{ padding:10px; }
    th{ text-align:left; }

    /* P√≥dio */
    #podioBlock{ margin-top:18px; }
    .podio-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:18px; justify-items:center; align-items:end; margin-top:8px; }
    .podio-col{ display:flex; flex-direction:column; align-items:center; }
    .podio-wrap{ height:160px; width:110px; display:flex; align-items:flex-end; justify-content:center; }
    .podio-bar{ width:86px; border-radius:12px; display:flex; align-items:flex-end; justify-content:center; box-shadow:0 10px 28px rgba(0,0,0,.3); }
    .podio-bar span{ font-weight:800; margin-bottom:8px; color:#111 }
    .podio-list{ font-size:.95rem; text-align:center; opacity:.95; max-width:220px; }

    /* Lobby */
    .lobby{ display:grid; gap:14px; justify-items:center; margin-top:8px; }
    .avatar-grid{
      display:grid; gap:8px; grid-template-columns:repeat(6, 42px);
      padding:10px; background:rgba(255,255,255,.08); border:1px solid var(--glass-border); border-radius:12px;
      max-width:min(360px, 92vw);
    }
    .avatar{
      width:42px; height:42px; border-radius:10px; background:#fff; color:#111; display:flex; align-items:center; justify-content:center;
      cursor:pointer; border:2px solid transparent; transition:.2s transform, .2s border-color;
      font-size:22px;
    }
    .avatar:hover{ transform:translateY(-2px) }
    .avatar.selected{ border-color:#22d3ee; }
    .input{ width:min(420px, 92vw); padding:12px 14px; border-radius:12px; border:1px solid var(--glass-border); font-size:16px; outline:none; }

    .hidden{ display:none!important; }
    .section-title{ font-size:var(--fs-lg); margin:0 0 8px; }
    .muted{ opacity:.9 }

    @media (max-width:768px){
      .container{ margin-top:76px }
      .options{ grid-template-columns:1fr; }
      .podio-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="logo-row">
      <img class="logo-eac" src="https://imgur.com/c5XQ7TW.png" alt="EAC">
      <div class="brand">EAC Quiz</div>
    </div>
    <div class="score-chip"><span id="avatarChip" style="font-size:18px">üòé</span><span id="score">0</span></div>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="home" class="hero">
      <img src="https://imgur.com/c5XQ7TW.png" alt="Logo EAC" style="width:96px; height:96px; border-radius:16px; object-fit:cover;"/>
      <h1>EAC Quiz</h1>
      <p class="sub">Desafie seus amigos e mostre quem manda bem! üí°‚ú®</p>

      <div class="hero-cta">
        <button class="btn primary" onclick="showLobby()">‚ö° Come√ßar agora!</button>
      </div>

      <div class="stats">
        <div class="stat"><b id="statPerguntas">‚Äî</b><small>Perguntas</small></div>
        <div class="stat"><b id="statTempo">15s</b><small>por quest√£o</small></div>
        <div class="stat"><b id="statPontos">1000+</b><small>pontos m√°x.</small></div>
      </div>
    </section>

    <!-- CARD PRINCIPAL -->
    <section id="tela" class="hidden">
      <div id="timer" class="timer hidden"><span id="timeLeft">30</span>s</div>

      <div id="progressContainer" class="progress hidden">
        <div class="bar"><div id="progressFill" class="fill"></div></div>
        <small>Pergunta <span id="currentQuestion">1</span> de <span id="totalQuestions">10</span></small>
      </div>

      <div id="content"></div>
    </section>
  </main>

<script>
  // ===== Estado global
  let score=0, streak=0, currentQuestionIndex=0, totalQuestions=0;
  let timeLeft=30, timerInterval=null;
  let NOME=null, AVATAR='üòé', QUIZ=null, PERGS=[];
  let quizzesCache=[]; let SINGLE_QUIZ_ID=null;
  let LAST_RESULT = null; // {acertos, total} do jogador ao finalizar


  const AVATARS = ['üòé','ü§©','üòá','üß†','‚ö°','üî•','üéØ','üê±','üê∂','üêº','üê∏','üêµ','ü¶ä','ü¶Å','üêØ','üê®','ü¶Ñ','üê≤'];

  // ===== Elementos
  const $home = document.getElementById('home');
  const $card = document.getElementById('tela');
  const contentElement = document.getElementById('content');
  const scoreElement = document.getElementById('score');
  const timerElement = document.getElementById('timer');
  const timeLeftElement = document.getElementById('timeLeft');
  const progressContainer = document.getElementById('progressContainer');
  const progressFill = document.getElementById('progressFill');
  const currentQuestionElement = document.getElementById('currentQuestion');
  const totalQuestionsElement = document.getElementById('totalQuestions');

  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  // ===== HOME -> LOBBY
  function showLobby(){
    hide($home);
    show($card);

    const ensureQuizzes = (cb)=>{
      if (quizzesCache && quizzesCache.length) return cb();
      google.script.run
        .withSuccessHandler(qs=>{ quizzesCache = qs||[]; cb(); })
        .withFailureHandler(()=>{ quizzesCache = []; cb(); })
        .getQuizzes();
    };

    ensureQuizzes(()=>{
      SINGLE_QUIZ_ID = quizzesCache.length === 1 ? quizzesCache[0].id : null;
      const hasMultiple = quizzesCache.length > 1;

      contentElement.innerHTML = `
        <h2 class="section-title">Escolha seu apelido e avatar</h2>
        <p class="muted">Seu nome aparecer√° no ranking. O avatar √© s√≥ para estilo üòé</p>

        <div class="lobby">
          <input id="nomeInput" class="input" placeholder="Digite seu nome..." maxlength="40" />
          <div class="avatar-grid" id="avatarGrid">
            ${AVATARS.map((a,i)=>`<button class="avatar ${i===0?'selected':''}" data-v="${a}" onclick="selectAvatar(this)">${a}</button>`).join('')}
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:8px;">
            ${hasMultiple ? `<button class="btn" onclick="loadQuizzesList()">üìö Escolher quiz</button>` : ``}
            <button class="btn primary" onclick="confirmLobby()">üöÄ Continuar</button>
            <button class="btn" onclick="goHome()">üè† In√≠cio</button>
          </div>
        </div>
      `;

      const saved = localStorage.getItem('EAO_LOBBY');
      if (saved){
        try{
          const o=JSON.parse(saved);
          document.getElementById('nomeInput').value = o.nome || '';
          AVATAR = o.avatar || AVATAR;
          document.getElementById('avatarChip').textContent = AVATAR;
          [...document.querySelectorAll('.avatar')].forEach(btn=>{
            btn.classList.toggle('selected', btn.dataset.v===AVATAR);
          });
        }catch(_){}
      }
    });
  }

  function selectAvatar(btn){
    AVATAR = btn.dataset.v;
    document.querySelectorAll('.avatar').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
  }

  function confirmLobby(){
    const nome = (document.getElementById('nomeInput').value || '').trim();
    if (!nome){ alert('Digite um nome v√°lido'); return; }
    NOME = nome;
    localStorage.setItem('EAO_LOBBY', JSON.stringify({nome:NOME, avatar:AVATAR}));
    document.getElementById('avatarChip').textContent = AVATAR;

    if (SINGLE_QUIZ_ID){
      startQuiz(SINGLE_QUIZ_ID);
    } else {
      loadQuizzesList();
    }
  }

  function goHome(){
    hide($card); show($home); scoreElement.textContent='0';
  }

  // ===== Dados
  function loadQuizzesList(){
    contentElement.innerHTML = `<div class="muted">Carregando lista...</div>`;
    show($card);
    google.script.run
      .withSuccessHandler(showQuizzes)
      .withFailureHandler(showError)
      .getQuizzes();
  }

  function showQuizzes(quizzes){
    quizzesCache = quizzes || [];
    if (!quizzesCache.length){
      contentElement.innerHTML = `
        <div class="muted">Nenhum quiz encontrado.</div>
        <div style="margin-top:10px;"><button class="btn" onclick="goHome()">Voltar</button></div>
      `;
      return;
    }
    contentElement.innerHTML = `
      <h2 class="section-title">Selecione um quiz</h2>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
        ${quizzesCache.map(q=>{
          const nome = q.nome.replace(/^quiz_/,'').replace(/_/g,' ').toUpperCase();
          return `
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
              <button class="btn primary" onclick="startQuiz('${q.id}')">‚ñ∂Ô∏è Jogar ‚Äî ${nome}</button>
              <button class="btn dark" onclick="showRanking('${q.id}','${nome}')">üìä Resultados</button>
            </div>
          `;
        }).join('')}
      </div>
      <div style="margin-top:14px;"><button class="btn" onclick="goHome()">In√≠cio</button></div>
    `;
  }

  function startQuiz(quizId){
    if (!NOME){ alert('Defina seu nome no lobby antes de jogar'); return; }
    QUIZ = quizId;

    score = 0; streak=0; currentQuestionIndex=0; scoreElement.textContent='0';
    progressFill.style.width='0%';
    contentElement.innerHTML = `<div class="muted">Carregando perguntas...</div>`;

    google.script.run
      .withSuccessHandler(loadPerguntas)
      .withFailureHandler(showError)
      .getPerguntas(QUIZ);
  }

  function loadPerguntas(pergs){
    PERGS = pergs || [];
    totalQuestions = PERGS.length;
    if (!totalQuestions){
      contentElement.innerHTML = `<div class="muted">Quiz sem perguntas.</div><div style="margin-top:10px"><button class="btn" onclick="loadQuizzesList()">Voltar</button></div>`;
      return;
    }
    show(progressContainer); show(timerElement);
    ask();
  }

  // ===== Timer / progresso
  function updateProgress(){
    const progress = ((currentQuestionIndex+1)/totalQuestions)*100;
    progressFill.style.width = progress+'%';
    currentQuestionElement.textContent = currentQuestionIndex+1;
    totalQuestionsElement.textContent = totalQuestions;
  }
  function startTimer(){
    timeLeft=30; timeLeftElement.textContent=timeLeft;
    timerElement.classList.remove('urgent');
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      timeLeft--; timeLeftElement.textContent=timeLeft;
      if (timeLeft<=10) timerElement.classList.add('urgent');
      if (timeLeft<=0){ clearInterval(timerInterval); handleTimeUp(); }
    },1000);
  }
  function stopTimer(){ clearInterval(timerInterval); }

  // ===== Quiz flow
  function ask(){
    if (currentQuestionIndex>=PERGS.length){ finish(); return; }
    const p = PERGS[currentQuestionIndex];
    if (!p || !Array.isArray(p.opcoes) || typeof p.correta!=='number'){
      contentElement.innerHTML = `<div class="muted">Pergunta inv√°lida.</div><div style="margin-top:10px"><button class="btn" onclick="loadQuizzesList()">Voltar</button></div>`;
      return;
    }
    const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    updateProgress();
    contentElement.innerHTML = `
      <h2 class="section-title" style="text-align:center">${esc(p.pergunta)}</h2>
      <div class="options">
        ${p.opcoes.map((t,i)=>`
          <button class="option ${['red','blue','yellow','green'][i]}" data-correct="${i===p.correta}" onclick="choose(${i},'${p.id}',false)">
            <span>${esc(t)}</span>
          </button>
        `).join('')}
      </div>
    `;
    startTimer();
  }

  function showFeedback(ok, msg){
    const div=document.createElement('div'); div.className=`feedback ${ok?'ok':'err'}`; div.textContent=msg;
    contentElement.appendChild(div); setTimeout(()=>div.remove(), 1600);
  }

  function handleTimeUp(){
    showFeedback(false,'Tempo esgotado!');
    const p = PERGS[currentQuestionIndex];
    choose(null, p.id, true);
  }

  function choose(indice, idPergunta, isTimeUp=false){
    stopTimer();
    const btns=[...document.querySelectorAll('.option')];
    btns.forEach(b=>{ b.classList.add('disabled'); b.style.pointerEvents='none'; });

    let isCorrect=false;
    const indiceOk = Number.isInteger(indice) && indice>=0 && indice<btns.length;

    if (!isTimeUp && indiceOk){
      const b = btns[indice];
      isCorrect = (b && b.dataset.correct==='true');
      b.classList.add(isCorrect?'correct':'incorrect');
      showFeedback(isCorrect,'Resposta ' + (isCorrect?'correta üéâ':'incorreta üòû'));
      if (isCorrect){ score += 100 + (streak*10); streak++; scoreElement.textContent = score; } else { streak=0; }
    } else {
      isCorrect=false;
    }

    btns.forEach(b=>{ if (b.dataset.correct==='true') b.classList.add('correct'); });

    const tempoGasto = Math.min(30, Math.max(0, 30 - (Number(timeLeft)||0)));
    const idxSalvar = (isTimeUp || !indiceOk) ? null : indice;

    google.script.run
      .withFailureHandler(showError)
      .saveResposta(NOME, QUIZ, idPergunta, idxSalvar, tempoGasto);

    setTimeout(()=>{ currentQuestionIndex++; ask(); }, 1500);
  }

  // ===== Finaliza√ß√£o: recalcula ranking e abre ranking
  function finish(){
    hide(progressContainer); hide(timerElement);
    contentElement.innerHTML = `<div class="muted">Calculando seu resultado...</div>`;

    // 1) fecha tentativa e pega {acertos,total}
    google.script.run
      .withSuccessHandler((res)=>{
        LAST_RESULT = res || null; // guarda resultado do jogador

        // 2) reprocessa o ranking desse quiz
        google.script.run
          .withSuccessHandler(()=>{
            // 3) carrega ranking e renderiza com banner personalizado
            google.script.run
              .withSuccessHandler((dados)=> renderRanking(QUIZ, '', dados || [], { playerName: NOME, avatar: AVATAR, lastResult: LAST_RESULT }))
              .withFailureHandler(showError)
              .getRanking(QUIZ);
          })
          .withFailureHandler(showError)
          .recomputarRankingQuiz(QUIZ);
      })
      .withFailureHandler(showError)
      .finalizarQuiz(NOME, QUIZ);
  }


  // ===== Ranking
  function showRanking(quizId, nomeFormatado=''){
    contentElement.innerHTML = `<div class="muted">Carregando resultados...</div>`;
    show($card);

    google.script.run
      .withSuccessHandler((dados)=> renderRanking(quizId, nomeFormatado, dados || [], { playerName: NOME, avatar: AVATAR, lastResult: LAST_RESULT }))
      .withFailureHandler(showError)
      .getRanking(quizId);
  }


  function renderRanking(quizId, nomeFormatado, ranking, opts = {}) {
    const { playerName = '', avatar = 'üòé', lastResult = null } = opts;
    const titulo = nomeFormatado || quizId;

    // Banner personalizado (se tivermos playerName ou lastResult)
    const playerBannerHTML = renderPlayerBanner(ranking, { playerName, avatar, lastResult });

    const podioHTML = renderPodioFromRanking(ranking);
    const hdrTempo = Array.isArray(ranking) && ranking.some(r => typeof r.tempo === 'number');
    const headerExtra = hdrTempo ? `<th style="text-align:center;">Tempo m√©dio (s)</th>` : '';

    const places = computePlacements(ranking||[]);
    const linhas = (!ranking||!ranking.length) ? '' : ranking.map((r,i)=>`
      <tr>
        <td style="text-align:center; font-weight:800">${places[i]}</td>
        <td>${r.nome}</td>
        <td style="text-align:center">${r.pontos}</td>
        ${hdrTempo?`<td style="text-align:center">${typeof r.tempo==='number'?r.tempo.toFixed(1):'‚Äî'}</td>`:''}
      </tr>
    `).join('');

    const tabela = (!ranking||!ranking.length) ? `<p class="muted">Sem registros ainda.</p>` : `
      <div class="table-wrap" style="margin-top:10px">
        <table>
          <thead><tr>
            <th style="text-align:center">#</th>
            <th>Nome</th>
            <th style="text-align:center">Acertos</th>
            ${headerExtra}
          </tr></thead>
          <tbody>${linhas}</tbody>
        </table>
      </div>
    `;

    contentElement.innerHTML = `
      <h2 class="section-title">üìä Resultados ‚Äî ${titulo}</h2>

      ${playerBannerHTML}      <!-- üëà banner do jogador -->
      ${podioHTML}
      ${tabela}

      <div style="display:flex; gap:10px; justify-content:center; margin:14px 0 18px; flex-wrap:wrap">
        <button class="btn primary" onclick="startQuiz('${quizId}')">‚ñ∂Ô∏è Jogar</button>
        <button class="btn" onclick="goHome()">üîô In√≠cio</button>
        <button class="btn" onclick="showRanking('${quizId}','${nomeFormatado}')">üîÅ Atualizar</button>
      </div>

      <h3 class="section-title" style="font-size:1.1rem">üïí Atividade recente</h3>
      <div id="recentActivity" class="muted">Carregando‚Ä¶</div>
    `;

    // ... mant√©m o restante da fun√ß√£o (carregar atividade recente) igual
    setTimeout(()=>{
      google.script.run
        .withSuccessHandler(rows=>{
          const host=document.getElementById('recentActivity');
          if (!rows||!rows.length){ host.textContent='Sem atividade recente.'; return; }
          const linhas = rows.map(r=>`
            <tr>
              <td style="padding:8px">${new Date(r.timestamp).toLocaleString()}</td>
              <td style="padding:8px">${r.nome}</td>
              <td style="padding:8px; text-align:center">${r.idPergunta}</td>
              <td style="padding:8px">${r.status}</td>
              <td style="padding:8px">${r.respostaDada}</td>
              <td style="padding:8px">${r.respostaCorreta}</td>
            </tr>
          `).join('');
          host.innerHTML = `
            <div class="table-wrap">
              <table>
                <thead><tr>
                  <th>Quando</th><th>Nome</th><th>Pergunta</th><th>Status</th><th>Dada</th><th>Correta</th>
                </tr></thead>
                <tbody>${linhas}</tbody>
              </table>
            </div>
          `;
        })
        .withFailureHandler(()=>{
          document.getElementById('recentActivity').innerHTML = `<span class="muted">Falha ao carregar.</span>`;
        })
        .getUltimosResultados(quizId, 30);
    }, 200);
  }


  // ===== Helpers de ranking/p√≥dio
  function computePlacements(items){
    if (!Array.isArray(items)) return [];
    const places=[]; let last=null, lastPlace=0;
    for (let i=0;i<items.length;i++){
      const cur=items[i]||{};
      const tie = last
        && Number(cur.pontos)===Number(last.pontos)
        && ( (cur.tempo==null && last.tempo==null) || (typeof cur.tempo==='number'&&typeof last.tempo==='number'&&cur.tempo===last.tempo) );
      lastPlace = tie ? lastPlace : (i+1);
      places.push(lastPlace); last=cur;
    }
    return places;
  }

  function renderPodioFromRanking(ranking){
    if (!Array.isArray(ranking)||!ranking.length){
      return `<div id="podioBlock"><p class="muted">Ainda n√£o h√° participantes.</p></div>`;
    }
    const places = computePlacements(ranking);
    const distinct = [...new Set(places)].slice(0,3);
    const buckets = distinct.map(p => ranking.filter((_,i)=>places[i]===p));

    const style = (place)=>({
      h: place===1?140:place===2?110:90,
      c: place===1?'#f0c419':place===2?'#c0c6cf':'#d59b6a',
      label: place===1?'ü•á 1¬∫':place===2?'ü•à 2¬∫':'ü•â 3¬∫'
    });

    const col = (place, group)=>{
      const s=style(place);
      if (!group||!group.length){
        return `
          <div class="podio-col">
            <div class="podio-wrap"><div class="podio-bar" style="height:${s.h}px; background:rgba(255,255,255,.1)"><span>‚Äî</span></div></div>
            <div style="margin-top:8px; font-weight:800">${s.label}</div>
            <div class="podio-list" style="opacity:.6">‚Äî</div>
          </div>
        `;
      }
      const itens = group.map(g=>{
        const nome=String(g.nome||''); const curto = nome.length>22?nome.slice(0,20)+'‚Ä¶':nome;
        const tempo = typeof g.tempo==='number' ? ` ¬∑ ${g.tempo.toFixed(1)}s` : '';
        const pts = typeof g.pontos==='number'?g.pontos:(Number(g.pontos)||0);
        return `<div style="display:flex; gap:6px; justify-content:center; margin:3px 0"><b>${pts} pts</b><span style="opacity:.65">‚Äî</span><span title="${nome}">${curto}${tempo}</span></div>`;
      }).join('');
      return `
        <div class="podio-col">
          <div class="podio-wrap"><div class="podio-bar" style="height:${s.h}px; background:${s.c}"><span>${group[0].pontos}</span></div></div>
          <div style="margin-top:8px; font-weight:800">${s.label}</div>
          <div class="podio-list">${itens}</div>
        </div>
      `;
    };

    const have1=buckets[0]?.length, have2=buckets[1]?.length, have3=buckets[2]?.length;
    const c2=have2?col(2,buckets[1]):col(2,[]),
          c1=have1?col(1,buckets[0]):col(1,[]),
          c3=have3?col(3,buckets[2]):col(3,[]);
    return `<div id="podioBlock"><h3 class="section-title" style="font-size:1.1rem; margin-bottom:8px;">ü•á Top 3 do Quiz</h3><div class="podio-grid">${c2}${c1}${c3}</div></div>`;
  }

  function renderPlayerBanner(ranking, { playerName, avatar, lastResult }) {
    if (!playerName && !lastResult) return '';

    // Procura o jogador no ranking atual
    const idx = (ranking || []).findIndex(r => String(r.nome||'').trim().toLowerCase() === String(playerName||'').trim().toLowerCase());
    const places = computePlacements(ranking||[]);
    const pos = idx >= 0 ? places[idx] : null;
    const item = idx >= 0 ? ranking[idx] : null;

    // Dados de resultado (do t√©rmino do quiz)
    const haveResult = !!(lastResult && typeof lastResult.acertos === 'number' && typeof lastResult.total === 'number');
    const pct = haveResult ? Math.round((lastResult.acertos / Math.max(1, lastResult.total)) * 100) : null;

    // Medal/icone por posi√ß√£o
    const medal = pos === 1 ? 'ü•á' : pos === 2 ? 'ü•à' : pos === 3 ? 'ü•â' : 'üèÖ';

    // Mensagem curta baseada no desempenho
    let headline = '';
    if (pos === 1) headline = `Top! Voc√™ est√° em 1¬∫ lugar ${medal}`;
    else if (pos === 2) headline = `Excelente! Voc√™ est√° em 2¬∫ ${medal}`;
    else if (pos === 3) headline = `Mandou bem! Voc√™ est√° em 3¬∫ ${medal}`;
    else if (haveResult && pct >= 80) headline = `Muito bom! ${pct}% de acertos ${medal}`;
    else if (haveResult && pct >= 60) headline = `Bom trabalho! ${pct}% de acertos`;
    else if (haveResult) headline = `Voc√™ fez ${pct}% ‚Äî continue tentando!`;

    // Subtexto com dados objetivos
    const ac = haveResult ? `${lastResult.acertos}/${lastResult.total}` : (item ? `${item.pontos} acertos` : '');
    const tempo = item && typeof item.tempo === 'number' ? ` ¬∑ tempo m√©dio ${item.tempo.toFixed(1)}s` : '';

    // Se n√£o achou no ranking, ainda assim mostra a mensagem de finaliza√ß√£o
    const linha2 = (playerName ? `<b>${playerName}</b>` : '') + (ac ? ` ‚Äî ${ac}` : '') + tempo;

    // Card bonito
    return `
      <div style="
        margin:12px 0 6px; padding:12px 14px; border-radius:14px;
        background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2);
        display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
      ">
        <div style="font-size:20px">${avatar || 'üòé'}</div>
        <div style="text-align:center">
          <div style="font-weight:800; margin-bottom:2px">${headline || 'Seu resultado foi registrado!'}</div>
          <div style="opacity:.95">${linha2}</div>
        </div>
      </div>
    `;
  }


  function showError(err){
    contentElement.innerHTML = `
      <div class="muted">Erro: ${err && err.message ? err.message : String(err)}</div>
      <div style="margin-top:10px"><button class="btn" onclick="goHome()">Voltar</button></div>
    `;
  }

  // ===== Home: carregar stats
  function updateHeroStats(){
    google.script.run
      .withSuccessHandler(qs=>{
        quizzesCache = qs || [];
        if (quizzesCache.length === 1) SINGLE_QUIZ_ID = quizzesCache[0].id;
        const first = quizzesCache[0];
        if (!first) return;
        google.script.run
          .withSuccessHandler(pergs=>{
            const n = (pergs||[]).length || '‚Äî';
            document.getElementById('statPerguntas').textContent = n;
            document.getElementById('statPontos').textContent = (n*200)+'+';
          })
          .withFailureHandler(()=>{})
          .getPerguntas(first.id);
      })
      .withFailureHandler(()=>{})
      .getQuizzes();
  }

  // ===== Inicial
  (function init(){
    show($home);
    // carrega avatar salvo
    const saved = localStorage.getItem('EAO_LOBBY');
    if (saved){
      try{
        const o = JSON.parse(saved);
        if (o.avatar) document.getElementById('avatarChip').textContent = o.avatar;
        if (o.nome) NOME = o.nome; // se j√° veio salvo, evita pedir de novo
      }catch(_){}
    }
    updateHeroStats();
  })();
</script>
</body>
</html>
